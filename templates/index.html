<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CSV ìš”ì•½ ì±—ë´‡</title>
  <style>
    /* ì™¼ìª½ íŒ¨ë„ì„ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒìœ¼ë¡œ, ë³¸ë¬¸ë§Œ ìŠ¤í¬ë¡¤ë˜ê²Œ */
    .panel.left{
      display: flex;
      flex-direction: column;
      overflow: hidden;          /* íŒ¨ë„ ìì²´ ìŠ¤í¬ë¡¤ ì œê±° */
    }
    /* ì™¼ìª½ íŒ¨ë„ì˜ ë³¸ë¬¸(í‘œ/ì •ë³´)ì€ ì—¬ê¸°ì—ì„œë§Œ ìŠ¤í¬ë¡¤ */
    .left-scroll{
      flex: 1 1 auto;
      overflow: auto;
      padding-bottom: 12px;      /* í‘¸í„° ë²„íŠ¼ê³¼ ê²¹ì¹¨ ë°©ì§€ */
    }

    /* í•˜ë‹¨ ë²„íŠ¼ì„ íŒ¨ë„ ë°”ë‹¥ì— ê³ ì • */
    .sticky-bottom{
      position: sticky;
      bottom: 0;                 /* í™”ë©´ í•˜ë‹¨ ê¸°ì¤€ìœ¼ë¡œ ë¶™ìŒ */
      padding: 12px 0 0 0;
      background: var(--panel);  /* ìŠ¤í¬ë¡¤ ì‹œ ê²¹ì¹˜ëŠ” ì˜ì—­ ìƒ‰ìƒ ìœ ì§€ */
      border-top: 1px solid var(--line);
    }
    /* ë¹„í™œì„±í™” ë²„íŠ¼ ì‹œê° í”¼ë“œë°± */
    button[disabled]{ filter: grayscale(1) opacity(0.5); cursor: not-allowed; }

    :root{
      --bg:#0f1115; --panel:#161a22; --line:#2a2f3a; --text:#e7e7ea; --muted:#9aa0a6; --accent:#4CAF50;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial
    }
    header{
      height:52px; display:flex; align-items:center; padding:0 16px;
      border-bottom:1px solid var(--line); background:#1b2030; font-weight:600
    }
    .layout {
      display: grid;
      grid-template-columns: 35% 45% 20%;
      height: calc(100vh - 52px);
    }
    .panel{ background:var(--panel); border-right:1px solid var(--line); padding:16px; overflow:auto}
    .panel.right{ border-right:0; border-left:1px solid var(--line)}
    .center{ padding:24px; overflow:auto}

    h1,h2,h3{margin:0 0 12px}
    .muted{color:var(--muted)}
    form{ margin-bottom:16px }
    input[type="file"], input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--line);
      border-radius:8px; background:#0f1320; color:var(--text)
    }
    .row{ display:grid; grid-template-columns:1fr auto; gap:8px; }
    button{
      padding:10px 14px; border:none; border-radius:8px; cursor:pointer;
      background:var(--accent); color:#fff; font-weight:600
    }
    button:hover{ filter:brightness(1.03) }
    table{ width:100%; border-collapse:collapse; margin-top:8px; background:#121621; border:1px solid var(--line) }
    th,td{ padding:8px; border-bottom:1px solid var(--line) }
    th{ background:#0f1320; text-align:left }
    .chat-list{
      display:flex; flex-direction:column; gap:10px;
      border:1px solid var(--line); border-radius:12px; padding:16px;
      background:#121621; min-height:280px;
      overflow: auto;
      max-height: 70vh; /* ì˜ˆì‹œ: ë†’ì´ ì œí•œ */
    }
    .bubble{ max-width:80%; padding:10px 12px; border-radius:12px; line-height:1.45; white-space:pre-wrap }
    .me{ align-self:flex-end; background:#24304a }
    .bot{ align-self:flex-start; background:#1e2433 }
    .file-card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#121621; margin-bottom:10px }
    .file-actions{ display:flex; gap:8px; margin-top:8px }
    .file-thumb{ width:100%; border-radius:8px; border:1px solid var(--line) }
    small{ color:var(--muted) }
    pre{background:#0f1320;border:1px solid var(--line);border-radius:8px;padding:12px;white-space:pre-wrap}
    /* ===== [ADD] ê°„ë‹¨ ì¹´ë“œ/ê·¸ë¦¬ë“œ ìœ í‹¸ ===== */
    .card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#121621; margin:12px 0; }
    .kv{ display:flex; justify-content:space-between; gap:12px; padding:4px 0; color:#c8c8d0; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937; color:#e7e7ea; font-size:12px; margin:2px; }
    .timeline{ position:relative; margin-top:12px; padding-left:18px }
    .timeline:before{ content:""; position:absolute; left:8px; top:0; bottom:0; width:2px; background:var(--line) }
    .step{ position:relative; margin:14px 0 }
    .step .dot{ position:absolute; left:-2px; top:6px; width:12px; height:12px; border-radius:50%; background:#5b6474; border:2px solid #0f1115 }
    .step .dot.done{ background:#2e7d32 }    /* ë…¹ìƒ‰ */
    .step .dot.skipped{ background:#545b66 } /* íšŒìƒ‰ */
    .step .body{ background:#11151f; border:1px solid var(--line); border-radius:12px; padding:12px; }
    .step .head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px }
    .status{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line) }
    .status.done{ background:#1b2b1c; color:#aee4b7; border-color:#234e2a }
    .status.skipped{ background:#1a1f2b; color:#a9b0ba }
    .mini{ font-size:12px; color:#aab0b8 }
    /* [ADD] ì™¼ìª½ íŒ¨ë„ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ & ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .sticky-bottom{ position: sticky; bottom: 16px; margin-top: 24px; }
    button[disabled]{ filter: grayscale(1) opacity(0.5); cursor: not-allowed; }

    /* ===== [ADD] ë ===== */
  </style>
</head>
<body>
<header>CSV ìš”ì•½ ì±—ë´‡</header>

<main class="layout">
  <!-- ì™¼ìª½: ì—…ë¡œë“œ + ë¯¸ë¦¬ë³´ê¸° -->
  <aside class="panel left">
    <div class="left-scroll">
      <h2>ì—…ë¡œë“œ</h2>
      <form action="/upload_csv/" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required />
        <div style="height:8px"></div>
        <button type="submit">ì—…ë¡œë“œ</button>
      </form>
      
      {% if head_rows %}
        <h3>{{ current_filename }} ìƒìœ„ 5í–‰</h3>
        <table>
          <thead>
            <tr>
              {% for col in head_columns %}<th>{{ col }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in head_rows %}
              <tr>
                {% for col in head_columns %}<td>{{ row[col] }}</td>{% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}      

      {% if df_info_text %}
        <h3 style="margin-top:16px">DataFrame info()</h3>
        <pre>{{ df_info_text }}</pre>
      {% endif %}

      
    </div>
      <!-- [ADD] ìë™ ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë²„íŠ¼ (ì™¼ìª½ í•˜ë‹¨ ê³ ì •) -->
      <div class="sticky-bottom">
      <form action="/run_workflow/" method="post">
        <input type="hidden" name="sessionId" value="{{ current_session or '' }}">
        <button type="submit"
          {% if not current_filename %}disabled title="CSVë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”"{% endif %}>
          âš™ï¸ ìë™ ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
        </button>
        <div class="mini" style="margin-top:6px;">
          {% if current_filename %}
            ëŒ€ìƒ íŒŒì¼: <b>{{ current_filename }}</b>
          {% else %}
            CSVë¥¼ ì—…ë¡œë“œí•˜ë©´ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
          {% endif %}
        </div>
      </form>
    </div>
  </aside>

  <!-- ì¤‘ì•™: ì±„íŒ… -->
  <section class="center">
    <h1>ğŸ’¬ Chat</h1>
    <div class="chat-list">
      {% if chat_history %}
        {% for chat in chat_history %}
          {% if chat.role == "user" %}
            <div class="bubble me">{{ chat.content }}</div>
          {% else %}
            <div class="bubble bot">{{ chat.content }}</div>
          {% endif %}
        {% endfor %}
      {% elif reply %}
        <div class="bubble bot">{{ reply }}</div>
      {% else %}
        <div class="muted">ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
      {% endif %}
    </div>
    <div style="height:10px"></div>
    <form class="row" action="/chat/" method="post">
      <input type="text" name="message" placeholder="ë©”ì‹œì§€ ì…ë ¥" required />
      <input type="hidden" name="sessionId" value="{{ current_session or '' }}">
      <button type="submit">ì „ì†¡</button>
    </form>
    <!-- [ADD] ì›Œí¬í”Œë¡œ ë‹¨ê³„ë³„ ê²°ê³¼ íƒ€ì„ë¼ì¸ -->
    {% if workflow and steps %}
      <div class="card">
        <h2 style="margin:0 0 8px 0;">ğŸ” ì›Œí¬í”Œë¡œ ë‹¨ê³„ë³„ ê²°ê³¼</h2>
        <div class="timeline">
          {% for s in steps %}
          <div class="step">
            <div class="dot {{ s.status }}"></div>
            <div class="body">
              <div class="head">
                <strong>{{ s.title }}</strong>
                <span class="status {{ s.status }}">{{ 'ì™„ë£Œ' if s.status=='done' else 'ê±´ë„ˆëœ€' }}</span>
              </div>

              {% if s.key == 'basic' and workflow.columnStats %}
                <div style="overflow:auto;">
                  <table>
                    <thead>
                      <tr><th>ì»¬ëŸ¼</th><th>íƒ€ì…</th><th>ê²°ì¸¡</th><th>ê³ ìœ </th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>ìµœì†Œ</th><th>ìµœëŒ€</th></tr>
                    </thead>
                    <tbody>
                      {% for c in workflow.columnStats %}
                        <tr>
                          <td><b>{{ c.column }}</b></td>
                          <td class="muted">{{ c.dtype }}</td>
                          <td>{{ c.missing }}</td>
                          <td>{{ c.unique }}</td>
                          <td>{{ "{:.2f}".format(c.mean) if c.mean is number else "â€”" }}</td>
                          <td>{{ "{:.2f}".format(c.std)  if c.std  is number else "â€”" }}</td>
                          <td>{{ c.min if c.min is not none else "â€”" }}</td>
                          <td>{{ c.max if c.max is not none else "â€”" }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              {% elif s.key == 'selector' %}
                <div class="mini">ì„ íƒ ì»¬ëŸ¼:</div>
                <div style="margin:4px 0 8px 0;">
                  {% for c in workflow.selectedColumns or [] %}
                    <span class="badge">{{ c }}</span>
                  {% endfor %}
                  {% if not workflow.selectedColumns %}<span class="muted">â€”</span>{% endif %}
                </div>

                <div class="mini" style="margin-top:6px;">ì‹œê°í™” ì¶”ì²œ í˜ì–´:</div>
                {% if workflow.recommendedPairs %}
                  {% for p in workflow.recommendedPairs %}
                    <div class="kv"><span>{{ p.column1 }} Ã— {{ p.column2 }}</span><button class="button">ê·¸ë¦¬ê¸°</button></div>
                  {% endfor %}
                {% else %}
                  <div class="muted">â€”</div>
                {% endif %}

                <div class="mini" style="margin-top:6px;">ì „ì²˜ë¦¬ ì¶”ì²œ:</div>
                <div style="overflow:auto;">
                  <table>
                    <thead><tr><th>ì»¬ëŸ¼</th><th>ê²°ì¸¡ì¹˜</th><th>ì •ê·œí™”</th><th>ì¸ì½”ë”©</th></tr></thead>
                    <tbody>
                      {% for r in workflow.preprocessingRecommendations or [] %}
                        <tr>
                          <td><b>{{ r.column }}</b></td>
                          <td class="muted">{{ r.fillna or "â€”" }}</td>
                          <td class="muted">{{ r.normalize or "â€”" }}</td>
                          <td class="muted">{{ r.encoding or "â€”" }}</td>
                        </tr>
                      {% endfor %}
                      {% if not workflow.preprocessingRecommendations %}
                        <tr><td colspan="4" class="muted">â€”</td></tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>

              {% elif s.key == 'visual' %}
                {% if workflow.chartUrls %}
                  <div class="grid3" style="display:grid;gap:12px;grid-template-columns:1fr;@media(min-width:1000px){grid-template-columns:1fr 1fr 1fr;}">
                    {% for url in workflow.chartUrls %}
                      <a href="{{ url }}" target="_blank"><img class="file-thumb" src="{{ url }}" alt="chart"></a>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="muted">ì¶”ì²œ í˜ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endif %}

              {% elif s.key == 'preprocess' %}
                {% if workflow.preprocessedFilePathUrl %}
                  <a class="button" href="{{ workflow.preprocessedFilePathUrl }}" target="_blank">ì „ì²˜ë¦¬ CSV ë‹¤ìš´ë¡œë“œ</a>
                {% else %}
                  <div class="muted">ì „ì²˜ë¦¬ íŒŒì¼ ì—†ìŒ</div>
                {% endif %}

              {% elif s.key == 'train' %}
                <div class="kv"><span class="muted">ì¶”ì²œ ëª¨ë¸</span>
                  <span>{{ workflow.mlModelRecommendation.model if workflow.mlModelRecommendation else 'â€”' }}</span></div>
                <div class="kv"><span class="muted">ì •í™•ë„</span>
                  <span>
                    {% if workflow.mlModelRecommendation and workflow.mlModelRecommendation.score is number %}
                      {{ (workflow.mlModelRecommendation.score*100)|round(1) }}%
                    {% else %}â€”{% endif %}
                  </span></div>
                {% if workflow.mlModelRecommendation and workflow.mlModelRecommendation.reason %}
                  <div class="muted" style="margin:4px 0;">ì‚¬ìœ : {{ workflow.mlModelRecommendation.reason }}</div>
                {% endif %}
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                  {% if workflow.mlResultPath and workflow.mlResultPath.mlResultUrl %}
                    <a class="button" href="{{ workflow.mlResultPath.mlResultUrl }}" target="_blank">ëª¨ë¸ íŒŒì¼</a>
                  {% endif %}
                  {% if workflow.mlResultPath and workflow.mlResultPath.reportUrl %}
                    <a class="button" href="{{ workflow.mlResultPath.reportUrl }}" target="_blank">ë¦¬í¬íŠ¸</a>
                  {% endif %}
                </div>
                {% if workflow.mlResultPath and workflow.mlResultPath.report %}
                  <details style="margin-top:8px;">
                    <summary>ë¦¬í¬íŠ¸ ë³´ê¸°</summary>
                    <pre>{{ workflow.mlResultPath.report }}</pre>
                  </details>
                {% endif %}
              {% endif %}
            </div>
          </div>
          {% endfor %}

        </div>
      </div>
    {% endif %}
    {% if preview_images %}
      <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
      {% for img in preview_images %}
        <div style="margin:12px 0">
          <img src="{{ img.url }}" class="file-thumb" alt="{{ img.name }}">
          <div class="file-actions">
            <a class="button" href="{{ img.url }}" download>ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</a>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </section>

  <!-- ì˜¤ë¥¸ìª½: ìƒì„±ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ -->
  <aside class="panel right">
  <h2>ìƒì„±ëœ íŒŒì¼</h2>
  {% if generated_files and generated_files|length > 0 %}
    {% for f in generated_files %}
      <div class="file-card">
        {% set is_img = f.ext in ['.png','.jpg','.jpeg','.webp','.gif'] %}
        {% if is_img %}
          <img class="file-thumb" src="{{ f.url }}" alt="{{ f.name }}">
        {% else %}
          <small>{{ f.name }}</small>
        {% endif %}
        <div class="file-actions">
          <a class="btn" href="{{ f.url }}" download="{{ f.name }}">Download</a>
        </div>
        <small>{{ f.name }} â€¢ {{ (f.size/1024)|round(1) }} KB</small>
      </div>
    {% endfor %}
  {% else %}
    <p class="muted">ì•„ì§ ìƒì„±ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</aside>
</main>
</body>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const chatList = document.querySelector(".chat-list");
    if (!chatList) return;

    // ë§ˆì§€ë§‰ ë§í’ì„  ìš”ì†Œ ì°¾ê¸°
    const lastBubble = chatList.querySelector(".bubble:last-child");
    if (lastBubble) {
      // ë¶€ë“œëŸ½ê²Œ í•´ë‹¹ ë§í’ì„ ì˜ ì‹œì‘ ë¶€ë¶„ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
      setTimeout(() => {
        lastBubble.scrollIntoView({ block: "start" });
      }, 100);
    }
  });
</script>

</html>
