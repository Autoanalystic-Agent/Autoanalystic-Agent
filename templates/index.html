<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CSV ìš”ì•½ ì±—ë´‡</title>
  <style>
    /* ì™¼ìª½ íŒ¨ë„ì„ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒìœ¼ë¡œ, ë³¸ë¬¸ë§Œ ìŠ¤í¬ë¡¤ë˜ê²Œ */
    .panel.left{
      display: flex;
      flex-direction: column;
      overflow: hidden;          /* íŒ¨ë„ ìì²´ ìŠ¤í¬ë¡¤ ì œê±° */
    }
    /* ì™¼ìª½ íŒ¨ë„ì˜ ë³¸ë¬¸(í‘œ/ì •ë³´)ì€ ì—¬ê¸°ì—ì„œë§Œ ìŠ¤í¬ë¡¤ */
    .left-scroll{
      flex: 1 1 auto;
      overflow: auto;
      padding-bottom: 12px;      /* í‘¸í„° ë²„íŠ¼ê³¼ ê²¹ì¹¨ ë°©ì§€ */
    }

    /* í•˜ë‹¨ ë²„íŠ¼ì„ íŒ¨ë„ ë°”ë‹¥ì— ê³ ì • */
    .sticky-bottom{
      position: sticky;
      bottom: 0;                 /* í™”ë©´ í•˜ë‹¨ ê¸°ì¤€ìœ¼ë¡œ ë¶™ìŒ */
      padding: 12px 0 0 0;
      background: var(--panel);  /* ìŠ¤í¬ë¡¤ ì‹œ ê²¹ì¹˜ëŠ” ì˜ì—­ ìƒ‰ìƒ ìœ ì§€ */
      border-top: 1px solid var(--line);
    }
    /* ë¹„í™œì„±í™” ë²„íŠ¼ ì‹œê° í”¼ë“œë°± */
    button[disabled]{ filter: grayscale(1) opacity(0.5); cursor: not-allowed; }

    :root{
      --bg:#0f1115; --panel:#161a22; --line:#2a2f3a; --text:#e7e7ea; --muted:#9aa0a6; --accent:#4CAF50;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial
    }
    header{
      height:52px; display:flex; align-items:center; padding:0 16px;
      border-bottom:1px solid var(--line); background:#1b2030; font-weight:600
    }
    .layout {
      display: grid;
      grid-template-columns: 35% 45% 20%;
      height: calc(100vh - 52px);
    }
    .panel{ background:var(--panel); border-right:1px solid var(--line); padding:16px; overflow:auto}
    .panel.right{ border-right:0; border-left:1px solid var(--line)}
    .center{ padding:24px; overflow:auto}

    h1,h2,h3{margin:0 0 12px}
    .muted{color:var(--muted)}
    form{ margin-bottom:16px }
    input[type="file"], input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--line);
      border-radius:8px; background:#0f1320; color:var(--text)
    }
    .row{ display:grid; grid-template-columns:1fr auto; gap:8px; }
    button{
      padding:10px 14px; border:none; border-radius:8px; cursor:pointer;
      background:var(--accent); color:#fff; font-weight:600
    }
    button:hover{ filter:brightness(1.03) }
    table{ width:100%; border-collapse:collapse; margin-top:8px; background:#121621; border:1px solid var(--line) }
    th,td{ padding:8px; border-bottom:1px solid var(--line) }
    th{ background:#0f1320; text-align:left }
    .chat-list{
      display:flex; flex-direction:column; gap:10px;
      border:1px solid var(--line); border-radius:12px; padding:16px;
      background:#121621; min-height:280px;
      overflow: auto;
      max-height: 70vh; /* ì˜ˆì‹œ: ë†’ì´ ì œí•œ */
    }
    .bubble{ max-width:80%; padding:10px 12px; border-radius:12px; line-height:1.45; white-space:pre-wrap }
    .me{ align-self:flex-end; background:#24304a }
    .bot{ align-self:flex-start; background:#1e2433 }
    .file-card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#121621; margin-bottom:10px }
    .file-actions{ display:flex; gap:8px; margin-top:8px }
    .file-thumb{ width:100%; border-radius:8px; border:1px solid var(--line) }
    small{ color:var(--muted) }
    pre{background:#0f1320;border:1px solid var(--line);border-radius:8px;padding:12px;white-space:pre-wrap}
    /* ===== [ADD] ê°„ë‹¨ ì¹´ë“œ/ê·¸ë¦¬ë“œ ìœ í‹¸ ===== */
    .card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#121621; margin:12px 0; }
    .kv{ display:flex; justify-content:space-between; gap:12px; padding:4px 0; color:#c8c8d0; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937; color:#e7e7ea; font-size:12px; margin:2px; }
    .timeline{ position:relative; margin-top:12px; padding-left:18px }
    .timeline:before{ content:""; position:absolute; left:8px; top:0; bottom:0; width:2px; background:var(--line) }
    .step{ position:relative; margin:14px 0 }
    .step .dot{ position:absolute; left:-2px; top:6px; width:12px; height:12px; border-radius:50%; background:#5b6474; border:2px solid #0f1115 }
    .step .dot.done{ background:#2e7d32 }    /* ë…¹ìƒ‰ */
    .step .dot.skipped{ background:#545b66 } /* íšŒìƒ‰ */
    .step .body{ background:#11151f; border:1px solid var(--line); border-radius:12px; padding:12px; }
    .step .head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px }
    .status{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line) }
    .status.done{ background:#1b2b1c; color:#aee4b7; border-color:#234e2a }
    .status.skipped{ background:#1a1f2b; color:#a9b0ba }
    .mini{ font-size:12px; color:#aab0b8 }
    /* [ADD] ì™¼ìª½ íŒ¨ë„ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ & ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .sticky-bottom{ position: sticky; bottom: 16px; margin-top: 24px; }
    button[disabled]{ filter: grayscale(1) opacity(0.5); cursor: not-allowed; }
    /* ===== [NEW] ìƒê´€í–‰ë ¬ í‘œ ìŠ¤íƒ€ì¼ ===== */
    #corr-table { width:100%; border-collapse:collapse; margin-top:8px; background:#121621; border:1px solid var(--line); } /* [NEW] */
    #corr-table th, #corr-table td { padding:8px; border-bottom:1px solid var(--line); text-align:right; }               /* [NEW] */
    #corr-table thead th { background:#0f1320; text-align:left; }                                                       /* [NEW] */
    #corr-table th:first-child, #corr-table td:first-child { text-align:left; }       
    /* ===== [ADD] ë ===== */
    /* â”€â”€ Markdown ë Œë”ë§ ì˜ì—­ ì „ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* í‘œ ì „ìš© ê°€ë¡œ ìŠ¤í¬ë¡¤ ë©í¼ */
    .md-scroll-x{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      margin:8px 0;
      padding-bottom:2px;
      border:1px solid var(--line);
      border-radius:8px;
      background:#121621;
    }

    /* ë§ˆí¬ë‹¤ìš´ í‘œ ê³µí†µ ë£°(ì±„íŒ… ì˜ì—­ ì•ˆì—ì„œë§Œ ì ìš©) â€” ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€í•´ë„ OK */
    .chat-list .md-rendered table{
      border-collapse:collapse;
      width:max-content;    /* ë‚´ìš©ë§Œí¼ ë„“ì–´ì§€ê¸° */
      min-width:100%;       /* ìµœì†Œí•œ ì»¨í…Œì´ë„ˆ ì±„ìš°ê¸° */
      background:#121621;
      border:1px solid var(--line);
    }
    .chat-list .md-rendered th,
    .chat-list .md-rendered td{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    .chat-list .md-rendered thead th{
      background:#0f1320; text-align:left;
    }
    /* íƒ€ì ì¤‘(typing) ë²„ë¸” */
    .typing {
      align-self:flex-start; background:#1e2433;
      padding:10px 12px; border-radius:12px; display:inline-flex; gap:6px;
    }
    .typing .dot {
      width:6px; height:6px; border-radius:50%; background:#c8ccd4;
      animation: blink 1.2s infinite ease-in-out;
    }
    .typing .dot:nth-child(2){ animation-delay:0.15s; }
    .typing .dot:nth-child(3){ animation-delay:0.3s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-2px); }
    }

    /* ì…ë ¥/ë²„íŠ¼ ë¹„í™œì„±í™” ì‹œ í‘œì‹œ */
    input[disabled], button[disabled]{
      filter: grayscale(1) opacity(0.6);
      cursor: not-allowed;
    }


  </style>
</head>
<body>
<header>CSV ìš”ì•½ ì±—ë´‡
  <button id="toggle-right-panel" style="
    margin-left:auto;
    background:none;
    border:none;
    color:#aee4b7;
    font-size:1rem;
    cursor:pointer;
    font-weight:600;
  ">ğŸ“ íŒŒì¼ ìˆ¨ê¸°ê¸°</button>
</header>

<main class="layout">
  <!-- ì™¼ìª½: ì—…ë¡œë“œ + ë¯¸ë¦¬ë³´ê¸° -->
  <aside class="panel left">
    <div class="left-scroll">
      <h2>ì—…ë¡œë“œ</h2>
      <form action="/upload_csv/" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required />
        <div style="height:8px"></div>
        <button type="submit">ì—…ë¡œë“œ</button>
      </form>
      
      {% if head_rows %}
        <h3>{{ current_filename }} ìƒìœ„ 5í–‰</h3>
        <table>
          <thead>
            <tr>
              {% for col in head_columns %}<th>{{ col }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in head_rows %}
              <tr>
                {% for col in head_columns %}<td>{{ row[col] }}</td>{% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}      

      {% if df_info_text %}
        <h3 style="margin-top:16px">DataFrame info()</h3>
        <pre>{{ df_info_text }}</pre>
      {% endif %}

      
    </div>
      <!-- [ADD] ìë™ ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë²„íŠ¼ (ì™¼ìª½ í•˜ë‹¨ ê³ ì •) -->
      <div class="sticky-bottom">
      <form action="/run_workflow/" method="post">
        <input type="hidden" name="sessionId" value="{{ current_session or '' }}">
        <button type="submit"
          {% if not current_filename %}disabled title="CSVë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”"{% endif %}>
          âš™ï¸ ìë™ ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
        </button>
        <div class="mini" style="margin-top:6px;">
          {% if current_filename %}
            ëŒ€ìƒ íŒŒì¼: <b>{{ current_filename }}</b>
          {% else %}
            CSVë¥¼ ì—…ë¡œë“œí•˜ë©´ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
          {% endif %}
        </div>
      </form>
    </div>
  </aside>

  <!-- ì¤‘ì•™: ì±„íŒ… -->
  <section class="center">
    <h1>ğŸ’¬ Chat</h1>

    <div class="chat-list" id="chatList">
      {% if chat_history %}
        {% for chat in chat_history %}
          {% if chat.role == "user" %}
            <div class="bubble me">{{ chat.content }}</div>
          {% else %}
            <!-- [MODIFIED] ë´‡ ë©”ì‹œì§€ë¥¼ Markdown ë Œë”ë§ ëŒ€ìƒìœ¼ë¡œ ë³€ê²½ -->
            <div class="bubble bot">
              <div class="md-raw" style="display:none;">{{ chat.content | e }}</div>
              <div class="md-rendered">ë¡œë”© ì¤‘...</div>
            </div>
          {% endif %}
        {% endfor %}
      {% elif reply %}
        <div class="bubble bot">{{ reply }}</div>
      {% else %}
        <div class="muted">ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
      {% endif %}
    </div>

    <div style="height:10px"></div>
    <form id="chatForm" class="row" action="/chat/" method="post">
      <input type="text" name="message" placeholder="ë©”ì‹œì§€ ì…ë ¥" required />
      <input type="hidden" name="sessionId" value="{{ current_session or '' }}">
      <button type="submit">ì „ì†¡</button>
    </form>

    <!-- [ADD] ì›Œí¬í”Œë¡œ ë‹¨ê³„ë³„ ê²°ê³¼ íƒ€ì„ë¼ì¸ -->
    {% if workflow and steps %}
      <div class="card">
        <h2 style="margin:0 0 8px 0;">ğŸ” ì›Œí¬í”Œë¡œ ë‹¨ê³„ë³„ ê²°ê³¼</h2>
        <div class="timeline">
          {% for s in steps %}
          <div class="step">
            <div class="dot {{ s.status }}"></div>
            <div class="body">
              <div class="head">
                <strong>{{ s.title }}</strong>
                <span class="status {{ s.status }}">{{ 'ì™„ë£Œ' if s.status=='done' else 'ê±´ë„ˆëœ€' }}</span>
              </div>

              {% if s.key == 'basic' and workflow.columnStats %}
                <div style="overflow:auto;">
                  <table>
                    <thead>
                      <tr><th>ì»¬ëŸ¼</th><th>íƒ€ì…</th><th>ê²°ì¸¡</th><th>ê³ ìœ </th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>ìµœì†Œ</th><th>ìµœëŒ€</th></tr>
                    </thead>
                    <tbody>
                      {% for c in workflow.columnStats %}
                        <tr>
                          <td><b>{{ c.column }}</b></td>
                          <td class="muted">{{ c.dtype }}</td>
                          <td>{{ c.missing }}</td>
                          <td>{{ c.unique }}</td>
                          <td>{{ "{:.2f}".format(c.mean) if c.mean is number else "â€”" }}</td>
                          <td>{{ "{:.2f}".format(c.std)  if c.std  is number else "â€”" }}</td>
                          <td>{{ c.min if c.min is not none else "â€”" }}</td>
                          <td>{{ c.max if c.max is not none else "â€”" }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              <!-- ===== [NEW] Correlation ë¸”ë¡ (Basic â†” Selector ì‚¬ì´) ===== -->
              {% elif s.key == 'corr' %}
                <div class="mini">ìƒê´€í–‰ë ¬ (Pearson)</div>
                {% if corr and corr.headers and corr.headers|length > 0 %}
                  <div style="overflow:auto; max-height:420px;">
                    <table id="corr-table">
                      <thead>
                        <tr>
                          <th style="position:sticky;left:0;z-index:2;background:#0f1320;"></th>
                          {% for h in corr.headers %}
                            <th>{{ h }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for r in corr.rows %}
                          <tr>
                            <th style="position:sticky;left:0;z-index:1;background:#0f1320;">{{ r.row }}</th>
                            {% for v in r.vals %}
                              {% set val = (v|float(default=0.0)) %}
                              <td class="corr-cell" data-val="{{ '%.3f' % val }}">
                                {{ '%.3f' % val }}
                              </td>
                            {% endfor %}
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  <small class="muted">* ì…€ ë°°ê²½ìƒ‰ì€ |ê°’|ì´ í´ìˆ˜ë¡ ì§„í•©ë‹ˆë‹¤. (+íŒŒë‘, âˆ’ì£¼í™©)</small>
                {% else %}
                  <div class="muted">ìˆ«ìí˜• ì»¬ëŸ¼ì´ ì—†ì–´ ìƒê´€í–‰ë ¬ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endif %}
              <!-- ===== [NEW] ë ===== -->

              {% elif s.key == 'selector' %}
                <div class="mini">ì„ íƒ ì»¬ëŸ¼:</div>
                <div style="margin:4px 0 8px 0;">
                  {% for c in workflow.selectedColumns or [] %}
                    <span class="badge">{{ c }}</span>
                  {% endfor %}
                  {% if not workflow.selectedColumns %}<span class="muted">â€”</span>{% endif %}
                </div>

                <div class="mini" style="margin-top:6px;">ì‹œê°í™” ì¶”ì²œ í˜ì–´:</div>
                {% if workflow.recommendedPairs %}
                  {% for p in workflow.recommendedPairs %}
                    <div class="kv"><span>{{ p.column1 }} Ã— {{ p.column2 }}</span><button class="button">ê·¸ë¦¬ê¸°</button></div>
                  {% endfor %}
                {% else %}
                  <div class="muted">â€”</div>
                {% endif %}

                <div class="mini" style="margin-top:6px;">ì „ì²˜ë¦¬ ì¶”ì²œ:</div>
                <div style="overflow:auto;">
                  <table>
                    <thead><tr><th>ì»¬ëŸ¼</th><th>ê²°ì¸¡ì¹˜</th><th>ì •ê·œí™”</th><th>ì¸ì½”ë”©</th></tr></thead>
                    <tbody>
                      {% for r in workflow.preprocessingRecommendations or [] %}
                        <tr>
                          <td><b>{{ r.column }}</b></td>
                          <td class="muted">{{ r.fillna or "â€”" }}</td>
                          <td class="muted">{{ r.normalize or "â€”" }}</td>
                          <td class="muted">{{ r.encoding or "â€”" }}</td>
                        </tr>
                      {% endfor %}
                      {% if not workflow.preprocessingRecommendations %}
                        <tr><td colspan="4" class="muted">â€”</td></tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>

              {% elif s.key == 'visual' %}
                {% if workflow.chartUrls %}
                  <div class="grid3" style="display:grid;gap:12px;grid-template-columns:1fr;@media(min-width:1000px){grid-template-columns:1fr 1fr 1fr;}">
                    {% for url in workflow.chartUrls %}
                      <a href="{{ url }}" target="_blank"><img class="file-thumb" src="{{ url }}" alt="chart"></a>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="muted">ì¶”ì²œ í˜ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endif %}

              {% elif s.key == 'preprocess' %}
                {% if workflow.preprocessedFilePathUrl %}
                  <a class="button" href="{{ workflow.preprocessedFilePathUrl }}" target="_blank">ì „ì²˜ë¦¬ CSV ë‹¤ìš´ë¡œë“œ</a>
                {% else %}
                  <div class="muted">ì „ì²˜ë¦¬ íŒŒì¼ ì—†ìŒ</div>
                {% endif %}

              {% elif s.key == 'train' %}
                <div class="kv"><span class="muted">ì¶”ì²œ ëª¨ë¸</span>
                  <span>{{ workflow.mlModelRecommendation.model if workflow.mlModelRecommendation else 'â€”' }}</span></div>
                <div class="kv"><span class="muted">ì •í™•ë„</span>
                  <span>
                    {% if workflow.mlModelRecommendation and workflow.mlModelRecommendation.score is number %}
                      {{ (workflow.mlModelRecommendation.score*100)|round(1) }}%
                    {% else %}â€”{% endif %}
                  </span></div>
                {% if workflow.mlModelRecommendation and workflow.mlModelRecommendation.reason %}
                  <div class="muted" style="margin:4px 0;">ì‚¬ìœ : {{ workflow.mlModelRecommendation.reason }}</div>
                {% endif %}
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                  {% if workflow.mlResultPath and workflow.mlResultPath.mlResultUrl %}
                    <a class="button" href="{{ workflow.mlResultPath.mlResultUrl }}" target="_blank">ëª¨ë¸ íŒŒì¼</a>
                  {% endif %}
                  {% if workflow.mlResultPath and workflow.mlResultPath.reportUrl %}
                    <a class="button" href="{{ workflow.mlResultPath.reportUrl }}" target="_blank">ë¦¬í¬íŠ¸</a>
                  {% endif %}
                </div>
                {% if workflow.mlResultPath and workflow.mlResultPath.report %}
                  <details style="margin-top:8px;">
                    <summary>ë¦¬í¬íŠ¸ ë³´ê¸°</summary>
                    <pre>{{ workflow.mlResultPath.report }}</pre>
                  </details>
                {% endif %}
              {% endif %}
            </div>
          </div>
          {% endfor %}

        </div>
      </div>
    {% endif %}
  </section>

  <!-- ì˜¤ë¥¸ìª½: ìƒì„±ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ -->
  <aside class="panel right">
  <h2>ìƒì„±ëœ íŒŒì¼</h2>
  {% if generated_files and generated_files|length > 0 %}
    {% for f in generated_files %}
      <div class="file-card">
        {% set is_img = f.ext in ['.png','.jpg','.jpeg','.webp','.gif'] %}
        {% if is_img %}
          <img class="file-thumb" src="{{ f.url }}" alt="{{ f.name }}">
        {% else %}
          <small>{{ f.name }}</small>
        {% endif %}
        <div class="file-actions">
          <a class="btn" href="{{ f.url }}" download="{{ f.name }}">Download</a>
        </div>
        <small>{{ f.name }} â€¢ {{ (f.size/1024)|round(1) }} KB</small>
      </div>
    {% endfor %}
  {% else %}
    <p class="muted">ì•„ì§ ìƒì„±ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</aside>
</main>

<!-- ===== [NEW] ìƒê´€í–‰ë ¬ ì…€ ìƒ‰ìƒ ìŠ¤í¬ë¦½íŠ¸ ===== -->
<script>
  (function colorizeCorr(){
    const table = document.getElementById('corr-table');
    if (!table) return;
    const cells = table.querySelectorAll('.corr-cell');
    cells.forEach(td => {
      const raw = td.dataset.val;
      const v = parseFloat(raw);
      if (!isFinite(v)) return;
      const a = Math.min(0.85, Math.abs(v));     // ë†ë„
      const hue = v >= 0 ? 210 : 20;             // +íŒŒë‘, -ì£¼í™©
      td.style.backgroundColor = `hsla(${hue}, 80%, 55%, ${a})`;
    });
  })();
</script>
<!-- ===== [NEW] ë ===== -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const nodes = document.querySelectorAll(".bot .md-raw");
    console.log("ë Œë”ë§ ëŒ€ìƒ:", nodes.length);
    nodes.forEach(rawNode => {
      const rawText = rawNode.textContent || "";
      if (!rawText.trim()) return;
      const html = marked.parse(rawText);
      const safe = DOMPurify.sanitize(html, {USE_PROFILES:{html:true}});
      const rendered = rawNode.parentElement.querySelector(".md-rendered");
      if (rendered) rendered.innerHTML = safe;
      rawNode.remove();
    });

    // ë Œë”ëœ ë§ˆí¬ë‹¤ìš´ ì•ˆì˜ <table>ì„ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë©í¼ë¡œ ê°ì‹¸ê¸°
    document.querySelectorAll(".bot .md-rendered").forEach(rendered => {
      rendered.querySelectorAll("table").forEach(tbl => {
        if (!tbl.parentElement.classList.contains("md-scroll-x")) {
          const wrap = document.createElement("div");
          wrap.className = "md-scroll-x";
          tbl.parentNode.insertBefore(wrap, tbl);
          wrap.appendChild(tbl);
        }
      });
    });

    // ìë™ ìŠ¤í¬ë¡¤
    const chatList = document.getElementById("chatList");
    if (chatList) setTimeout(() => chatList.scrollTop = chatList.scrollHeight, 300);
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const chatList = document.querySelector(".chat-list");
    if (!chatList) return;

    // ë§ˆì§€ë§‰ ë§í’ì„  ìš”ì†Œ ì°¾ê¸°
    const lastBubble = chatList.querySelector(".bubble:last-child");
    if (lastBubble) {
      // ë¶€ë“œëŸ½ê²Œ í•´ë‹¹ ë§í’ì„ ì˜ ì‹œì‘ ë¶€ë¶„ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
      setTimeout(() => {
        lastBubble.scrollIntoView({ block: "start" });
      }, 100);
    }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const toggleBtn = document.getElementById("toggle-right-panel");
  const rightPanel = document.querySelector(".panel.right");
  const layout = document.querySelector(".layout");

  let isHidden = false;

  toggleBtn.addEventListener("click", () => {
    isHidden = !isHidden;

    if (isHidden) {
      rightPanel.style.display = "none";
      layout.style.gridTemplateColumns = "40% 60%"; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ìˆ¨ê¹€ â†’ ì¤‘ì•™ í™•ì¥
      toggleBtn.textContent = "ğŸ“ íŒŒì¼ ë³´ê¸°";
    } else {
      rightPanel.style.display = "block";
      layout.style.gridTemplateColumns = "35% 45% 20%"; // ì›ë˜ ë¹„ìœ¨ ë³µì›
      toggleBtn.textContent = "ğŸ“ íŒŒì¼ ìˆ¨ê¸°ê¸°";
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const chatForm   = document.getElementById("chatForm");              
  const chatInput  = chatForm?.querySelector('input[name="message"]');
  const chatSendBtn= chatForm?.querySelector('button[type="submit"]');
  const chatList   = document.getElementById("chatList");
  let pending = false;

  // ë§ˆí¬ë‹¤ìš´ ë Œë” + í‘œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë˜í•‘
  function renderMarkdownInBubbles(root) {
    const nodes = root.querySelectorAll(".bot .md-raw");
    nodes.forEach(rawNode => {
      const rawText = rawNode.textContent || "";
      if (!rawText.trim()) return;
      const html = marked.parse(rawText);
      const safe = DOMPurify.sanitize(html, {USE_PROFILES:{html:true}});
      const rendered = rawNode.parentElement.querySelector(".md-rendered");
      if (rendered) rendered.innerHTML = safe;
      rawNode.remove();
    });
    root.querySelectorAll(".bot .md-rendered").forEach(rendered => {
      rendered.querySelectorAll("table").forEach(tbl => {
        if (!tbl.parentElement.classList.contains("md-scroll-x")) {
          const wrap = document.createElement("div");
          wrap.className = "md-scroll-x";
          tbl.parentNode.insertBefore(wrap, tbl);
          wrap.appendChild(tbl);
        }
      });
    });
  }

  function addTypingBubble() {
    const chatList = document.getElementById("chatList");
    if (!chatList) return;

    // ì´ë¯¸ í‘œì‹œ ì¤‘ì´ë©´ ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŒ(ì¤‘ë³µ ë°©ì§€)
    const already = chatList.querySelector('.bubble.bot.typing[data-typing="true"]');
    if (already) return;

    const bubble = document.createElement("div");
    bubble.className = "bubble bot typing";         // â† .bot .typing ë‘˜ ë‹¤!
    bubble.dataset.typing = "true";
    bubble.setAttribute("aria-live", "polite");
    bubble.setAttribute("aria-label", "ë‹µë³€ ì‘ì„± ì¤‘");

    // ì (â€¦) ì• ë‹ˆë©”ì´ì…˜ 3ê°œ
    bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';

    chatList.appendChild(bubble);
    chatList.scrollTop = chatList.scrollHeight;
  }

  function removeTypingBubble() {
    const chatList = document.getElementById("chatList");
    if (!chatList) return;

    const typing = chatList.querySelector('.bubble.bot.typing[data-typing="true"]');
    if (typing && typing.parentNode) typing.parentNode.removeChild(typing);
  }

  if (chatForm && chatInput && chatSendBtn && chatList) {
    chatForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      if (pending) return;
      pending = true;

      // â­ FormDataë¥¼ ë¨¼ì € ë§Œë“ ë‹¤ (disabled ì „ì—!)
      const fd = new FormData(chatForm);
      const userMsg = chatInput.value;

      // ì…ë ¥/ë²„íŠ¼ ì ê¸ˆ
      const prevPlaceholder = chatInput.placeholder;
      const prevBtnText = chatSendBtn.textContent;
      chatInput.disabled = true;
      chatSendBtn.disabled = true;
      chatInput.placeholder = "ì‘ë‹µ ì‘ì„± ì¤‘â€¦";
      chatSendBtn.textContent = "ì‘ë‹µ ì¤‘â€¦";

      // ë‚´ ë©”ì‹œì§€ ì¦‰ì‹œ í‘œì‹œ(ì˜µì…˜)
      if (userMsg.trim()) {
        const me = document.createElement("div");
        me.className = "bubble me";
        me.textContent = userMsg;
        chatList.appendChild(me);
      }

      // íƒ€ì(â€¦) í‘œì‹œ
      addTypingBubble();

      try {
        const res = await fetch(chatForm.action, { method: "POST", body: fd });
        const html = await res.text();

        // ì‘ë‹µì—ì„œ #chatListë§Œ êµì²´
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const newChatList = doc.querySelector("#chatList");

        removeTypingBubble();

        if (newChatList) {
          chatList.replaceChildren(...newChatList.childNodes);
          renderMarkdownInBubbles(chatList);
          chatList.scrollTop = chatList.scrollHeight;
        }

        // (ì„ íƒ) ì˜¤ë¥¸ìª½ íŒ¨ë„ ë™ê¸° ê°±ì‹ 
        const newRight = doc.querySelector(".panel.right");
        const curRight = document.querySelector(".panel.right");
        if (newRight && curRight) curRight.innerHTML = newRight.innerHTML;

      } catch (err) {
        console.error(err);
        removeTypingBubble();
        const errBubble = document.createElement("div");
        errBubble.className = "bubble bot";
        errBubble.textContent = "âš ï¸ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        chatList.appendChild(errBubble);
      } finally {
        chatInput.value = "";
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.placeholder = prevPlaceholder;
        chatSendBtn.textContent = prevBtnText;
        chatInput.focus();
        pending = false;
      }
    });
  }

  // (ì„ íƒ) ì›Œí¬í”Œë¡œìš° ë²„íŠ¼ ì ê¸ˆ í‘œì‹œ
  const wfForm = document.querySelector('form[action="/run_workflow/"]');
  if (wfForm) {
    const wfBtn = wfForm.querySelector('button[type="submit"]');
    wfForm.addEventListener("submit", () => {
      if (!wfBtn) return;
      wfBtn.disabled = true;
      wfBtn.dataset.old = wfBtn.textContent;
      wfBtn.textContent = "ì‹¤í–‰ ì¤‘â€¦";
    });
  }
});
</script>

</body>
</html>
