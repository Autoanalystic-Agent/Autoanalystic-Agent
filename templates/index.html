<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CSV 요약 챗봇</title>
  <style>
    /* 왼쪽 패널을 컬럼 레이아웃으로, 본문만 스크롤되게 */
    .panel.left{
      display: flex;
      flex-direction: column;
      overflow: hidden;          /* 패널 자체 스크롤 제거 */
    }
    /* 왼쪽 패널의 본문(표/정보)은 여기에서만 스크롤 */
    .left-scroll{
      flex: 1 1 auto;
      overflow: auto;
      padding-bottom: 12px;      /* 푸터 버튼과 겹침 방지 */
    }

    /* 하단 버튼을 패널 바닥에 고정 */
    .sticky-bottom{
      position: sticky;
      bottom: 0;                 /* 화면 하단 기준으로 붙음 */
      padding: 12px 0 0 0;
      background: var(--panel);  /* 스크롤 시 겹치는 영역 색상 유지 */
      border-top: 1px solid var(--line);
    }
    /* 비활성화 버튼 시각 피드백 */
    button[disabled]{ filter: grayscale(1) opacity(0.5); cursor: not-allowed; }

    :root{
      --bg:#0f1115; --panel:#161a22; --line:#2a2f3a; --text:#e7e7ea; --muted:#9aa0a6; --accent:#4CAF50;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial
    }
    header{
      height:52px; display:flex; align-items:center; padding:0 16px;
      border-bottom:1px solid var(--line); background:#1b2030; font-weight:600
    }
    .layout {
      display: grid;
      grid-template-columns: 35% 45% 20%;
      height: calc(100vh - 52px);
    }
    .panel{ background:var(--panel); border-right:1px solid var(--line); padding:16px; overflow:auto}
    .panel.right{ border-right:0; border-left:1px solid var(--line)}
    .center{ padding:24px; overflow:auto}

    h1,h2,h3{margin:0 0 12px}
    .muted{color:var(--muted)}
    form{ margin-bottom:16px }
    input[type="file"], input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--line);
      border-radius:8px; background:#0f1320; color:var(--text)
    }
    .row{ display:grid; grid-template-columns:1fr auto; gap:8px; }
    button{
      padding:10px 14px; border:none; border-radius:8px; cursor:pointer;
      background:var(--accent); color:#fff; font-weight:600
    }
    button:hover{ filter:brightness(1.03) }
    table{ width:100%; border-collapse:collapse; margin-top:8px; background:#121621; border:1px solid var(--line) }
    th,td{ padding:8px; border-bottom:1px solid var(--line) }
    th{ background:#0f1320; text-align:left }
    .chat-list{
      display:flex; flex-direction:column; gap:10px;
      border:1px solid var(--line); border-radius:12px; padding:16px;
      background:#121621; min-height:280px;
      overflow: auto;
      max-height: 70vh; /* 예시: 높이 제한 */
    }
    .bubble{ max-width:80%; padding:10px 12px; border-radius:12px; line-height:1.45; white-space:pre-wrap }
    .me{ align-self:flex-end; background:#24304a }
    .bot{ align-self:flex-start; background:#1e2433 }
    .file-card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#121621; margin-bottom:10px }
    .file-actions{ display:flex; gap:8px; margin-top:8px }
    .file-thumb{ width:100%; border-radius:8px; border:1px solid var(--line) }
    small{ color:var(--muted) }
    pre{background:#0f1320;border:1px solid var(--line);border-radius:8px;padding:12px;white-space:pre-wrap}
    /* ===== [ADD] 간단 카드/그리드 유틸 ===== */
    .card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#121621; margin:12px 0; }
    .kv{ display:flex; justify-content:space-between; gap:12px; padding:4px 0; color:#c8c8d0; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937; color:#e7e7ea; font-size:12px; margin:2px; }
    .timeline{ position:relative; margin-top:12px; padding-left:18px }
    .timeline:before{ content:""; position:absolute; left:8px; top:0; bottom:0; width:2px; background:var(--line) }
    .step{ position:relative; margin:14px 0 }
    .step .dot{ position:absolute; left:-2px; top:6px; width:12px; height:12px; border-radius:50%; background:#5b6474; border:2px solid #0f1115 }
    .step .dot.done{ background:#2e7d32 }    /* 녹색 */
    .step .dot.skipped{ background:#545b66 } /* 회색 */
    .step .body{ background:#11151f; border:1px solid var(--line); border-radius:12px; padding:12px; }
    .step .head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px }
    .status{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line) }
    .status.done{ background:#1b2b1c; color:#aee4b7; border-color:#234e2a }
    .status.skipped{ background:#1a1f2b; color:#a9b0ba }
    .mini{ font-size:12px; color:#aab0b8 }
    /* [ADD] 왼쪽 패널 하단 고정 버튼 & 비활성화 스타일 */
    .sticky-bottom{ position: sticky; bottom: 16px; margin-top: 24px; }
    button[disabled]{ filter: grayscale(1) opacity(0.5); cursor: not-allowed; }
    /* ===== [NEW] 상관행렬 표 스타일 ===== */
    #corr-table { width:100%; border-collapse:collapse; margin-top:8px; background:#121621; border:1px solid var(--line); } /* [NEW] */
    #corr-table th, #corr-table td { padding:8px; border-bottom:1px solid var(--line); text-align:right; }               /* [NEW] */
    #corr-table thead th { background:#0f1320; text-align:left; }                                                       /* [NEW] */
    #corr-table th:first-child, #corr-table td:first-child { text-align:left; }       
    /* ===== [ADD] 끝 ===== */
    /* ── Markdown 렌더링 영역 전용 ───────────────────────────── */
    /* 표 전용 가로 스크롤 랩퍼 */
    .md-scroll-x{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      margin:8px 0;
      padding-bottom:2px;
      border:1px solid var(--line);
      border-radius:8px;
      background:#121621;
    }

    /* 마크다운 표 공통 룰(채팅 영역 안에서만 적용) — 기존 그대로 유지해도 OK */
    .chat-list .md-rendered table{
      border-collapse:collapse;
      width:max-content;    /* 내용만큼 넓어지기 */
      min-width:100%;       /* 최소한 컨테이너 채우기 */
      background:#121621;
      border:1px solid var(--line);
    }
    .chat-list .md-rendered th,
    .chat-list .md-rendered td{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    .chat-list .md-rendered thead th{
      background:#0f1320; text-align:left;
    }
    /* 타자 중(typing) 버블 */
    .typing {
      align-self:flex-start; background:#1e2433;
      padding:10px 12px; border-radius:12px; display:inline-flex; gap:6px;
    }
    .typing .dot {
      width:6px; height:6px; border-radius:50%; background:#c8ccd4;
      animation: blink 1.2s infinite ease-in-out;
    }
    .typing .dot:nth-child(2){ animation-delay:0.15s; }
    .typing .dot:nth-child(3){ animation-delay:0.3s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-2px); }
    }

    /* 입력/버튼 비활성화 시 표시 */
    input[disabled], button[disabled]{
      filter: grayscale(1) opacity(0.6);
      cursor: not-allowed;
    }


  </style>
</head>
<body>
<header>CSV 요약 챗봇
  <button id="toggle-right-panel" style="
    margin-left:auto;
    background:none;
    border:none;
    color:#aee4b7;
    font-size:1rem;
    cursor:pointer;
    font-weight:600;
  ">📁 파일 숨기기</button>
</header>

<main class="layout">
  <!-- 왼쪽: 업로드 + 미리보기 -->
  <aside class="panel left">
    <div class="left-scroll">
      <h2>업로드</h2>
      <form action="/upload_csv/" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required />
        <div style="height:8px"></div>
        <button type="submit">업로드</button>
      </form>
      
      {% if head_rows %}
        <h3>{{ current_filename }} 상위 5행</h3>
        <table>
          <thead>
            <tr>
              {% for col in head_columns %}<th>{{ col }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in head_rows %}
              <tr>
                {% for col in head_columns %}<td>{{ row[col] }}</td>{% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}      

      {% if df_info_text %}
        <h3 style="margin-top:16px">DataFrame info()</h3>
        <pre>{{ df_info_text }}</pre>
      {% endif %}

      
    </div>
      <!-- [ADD] 자동 분석 파이프라인 실행 버튼 (왼쪽 하단 고정) -->
      <div class="sticky-bottom">
      <form action="/run_workflow/" method="post">
        <input type="hidden" name="sessionId" value="{{ current_session or '' }}">
        <button type="submit"
          {% if not current_filename %}disabled title="CSV를 업로드하세요"{% endif %}>
          ⚙️ 자동 분석 파이프라인 실행
        </button>
        <div class="mini" style="margin-top:6px;">
          {% if current_filename %}
            대상 파일: <b>{{ current_filename }}</b>
          {% else %}
            CSV를 업로드하면 버튼이 활성화됩니다.
          {% endif %}
        </div>
      </form>
    </div>
  </aside>

  <!-- 중앙: 채팅 -->
  <section class="center">
    <h1>💬 Chat</h1>

    <div class="chat-list" id="chatList">
      {% if chat_history %}
        {% for chat in chat_history %}
          {% if chat.role == "user" %}
            <div class="bubble me">{{ chat.content }}</div>
          {% else %}
            <!-- [MODIFIED] 봇 메시지를 Markdown 렌더링 대상으로 변경 -->
            <div class="bubble bot">
              <div class="md-raw" style="display:none;">{{ chat.content | e }}</div>
              <div class="md-rendered">로딩 중...</div>
            </div>
          {% endif %}
        {% endfor %}
      {% elif reply %}
        <div class="bubble bot">{{ reply }}</div>
      {% else %}
        <div class="muted">메시지를 입력해 대화를 시작하세요.</div>
      {% endif %}
    </div>

    <div style="height:10px"></div>
    <form id="chatForm" class="row" action="/chat/" method="post">
      <input type="text" name="message" placeholder="메시지 입력" required />
      <input type="hidden" name="sessionId" value="{{ current_session or '' }}">
      <button type="submit">전송</button>
    </form>

    <!-- [ADD] 워크플로 단계별 결과 타임라인 -->
    {% if workflow and steps %}
      <div class="card">
        <h2 style="margin:0 0 8px 0;">🔎 워크플로 단계별 결과</h2>
        <div class="timeline">
          {% for s in steps %}
          <div class="step">
            <div class="dot {{ s.status }}"></div>
            <div class="body">
              <div class="head">
                <strong>{{ s.title }}</strong>
                <span class="status {{ s.status }}">{{ '완료' if s.status=='done' else '건너뜀' }}</span>
              </div>

              {% if s.key == 'basic' and workflow.columnStats %}
                <div style="overflow:auto;">
                  <table>
                    <thead>
                      <tr><th>컬럼</th><th>타입</th><th>결측</th><th>고유</th><th>평균</th><th>표준편차</th><th>최소</th><th>최대</th></tr>
                    </thead>
                    <tbody>
                      {% for c in workflow.columnStats %}
                        <tr>
                          <td><b>{{ c.column }}</b></td>
                          <td class="muted">{{ c.dtype }}</td>
                          <td>{{ c.missing }}</td>
                          <td>{{ c.unique }}</td>
                          <td>{{ "{:.2f}".format(c.mean) if c.mean is number else "—" }}</td>
                          <td>{{ "{:.2f}".format(c.std)  if c.std  is number else "—" }}</td>
                          <td>{{ c.min if c.min is not none else "—" }}</td>
                          <td>{{ c.max if c.max is not none else "—" }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              <!-- ===== [NEW] Correlation 블록 (Basic ↔ Selector 사이) ===== -->
              {% elif s.key == 'corr' %}
                <div class="mini">상관행렬 (Pearson)</div>
                {% if corr and corr.headers and corr.headers|length > 0 %}
                  <div style="overflow:auto; max-height:420px;">
                    <table id="corr-table">
                      <thead>
                        <tr>
                          <th style="position:sticky;left:0;z-index:2;background:#0f1320;"></th>
                          {% for h in corr.headers %}
                            <th>{{ h }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for r in corr.rows %}
                          <tr>
                            <th style="position:sticky;left:0;z-index:1;background:#0f1320;">{{ r.row }}</th>
                            {% for v in r.vals %}
                              {% set val = (v|float(default=0.0)) %}
                              <td class="corr-cell" data-val="{{ '%.3f' % val }}">
                                {{ '%.3f' % val }}
                              </td>
                            {% endfor %}
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  <small class="muted">* 셀 배경색은 |값|이 클수록 진합니다. (+파랑, −주황)</small>
                {% else %}
                  <div class="muted">숫자형 컬럼이 없어 상관행렬을 표시할 수 없습니다.</div>
                {% endif %}
              <!-- ===== [NEW] 끝 ===== -->

              {% elif s.key == 'selector' %}
                <div class="mini">선택 컬럼:</div>
                <div style="margin:4px 0 8px 0;">
                  {% for c in workflow.selectedColumns or [] %}
                    <span class="badge">{{ c }}</span>
                  {% endfor %}
                  {% if not workflow.selectedColumns %}<span class="muted">—</span>{% endif %}
                </div>

                <div class="mini" style="margin-top:6px;">시각화 추천 페어:</div>
                {% if workflow.recommendedPairs %}
                  {% for p in workflow.recommendedPairs %}
                    <div class="kv"><span>{{ p.column1 }} × {{ p.column2 }}</span><button class="button">그리기</button></div>
                  {% endfor %}
                {% else %}
                  <div class="muted">—</div>
                {% endif %}

                <div class="mini" style="margin-top:6px;">전처리 추천:</div>
                <div style="overflow:auto;">
                  <table>
                    <thead><tr><th>컬럼</th><th>결측치</th><th>정규화</th><th>인코딩</th></tr></thead>
                    <tbody>
                      {% for r in workflow.preprocessingRecommendations or [] %}
                        <tr>
                          <td><b>{{ r.column }}</b></td>
                          <td class="muted">{{ r.fillna or "—" }}</td>
                          <td class="muted">{{ r.normalize or "—" }}</td>
                          <td class="muted">{{ r.encoding or "—" }}</td>
                        </tr>
                      {% endfor %}
                      {% if not workflow.preprocessingRecommendations %}
                        <tr><td colspan="4" class="muted">—</td></tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>

              {% elif s.key == 'visual' %}
                {% if workflow.chartUrls %}
                  <div class="grid3" style="display:grid;gap:12px;grid-template-columns:1fr;@media(min-width:1000px){grid-template-columns:1fr 1fr 1fr;}">
                    {% for url in workflow.chartUrls %}
                      <a href="{{ url }}" target="_blank"><img class="file-thumb" src="{{ url }}" alt="chart"></a>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="muted">추천 페어를 기반으로 생성된 차트가 없습니다.</div>
                {% endif %}

              {% elif s.key == 'preprocess' %}
                {% if workflow.preprocessedFilePathUrl %}
                  <a class="button" href="{{ workflow.preprocessedFilePathUrl }}" target="_blank">전처리 CSV 다운로드</a>
                {% else %}
                  <div class="muted">전처리 파일 없음</div>
                {% endif %}

              {% elif s.key == 'train' %}
                <div class="kv"><span class="muted">추천 모델</span>
                  <span>{{ workflow.mlModelRecommendation.model if workflow.mlModelRecommendation else '—' }}</span></div>
                <div class="kv"><span class="muted">정확도</span>
                  <span>
                    {% if workflow.mlModelRecommendation and workflow.mlModelRecommendation.score is number %}
                      {{ (workflow.mlModelRecommendation.score*100)|round(1) }}%
                    {% else %}—{% endif %}
                  </span></div>
                {% if workflow.mlModelRecommendation and workflow.mlModelRecommendation.reason %}
                  <div class="muted" style="margin:4px 0;">사유: {{ workflow.mlModelRecommendation.reason }}</div>
                {% endif %}
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                  {% if workflow.mlResultPath and workflow.mlResultPath.mlResultUrl %}
                    <a class="button" href="{{ workflow.mlResultPath.mlResultUrl }}" target="_blank">모델 파일</a>
                  {% endif %}
                  {% if workflow.mlResultPath and workflow.mlResultPath.reportUrl %}
                    <a class="button" href="{{ workflow.mlResultPath.reportUrl }}" target="_blank">리포트</a>
                  {% endif %}
                </div>
                {% if workflow.mlResultPath and workflow.mlResultPath.report %}
                  <details style="margin-top:8px;">
                    <summary>리포트 보기</summary>
                    <pre>{{ workflow.mlResultPath.report }}</pre>
                  </details>
                {% endif %}
              {% endif %}
            </div>
          </div>
          {% endfor %}

        </div>
      </div>
    {% endif %}
  </section>

  <!-- 오른쪽: 생성된 파일 다운로드 -->
  <aside class="panel right">
  <h2>생성된 파일</h2>
  {% if generated_files and generated_files|length > 0 %}
    {% for f in generated_files %}
      <div class="file-card">
        {% set is_img = f.ext in ['.png','.jpg','.jpeg','.webp','.gif'] %}
        {% if is_img %}
          <img class="file-thumb" src="{{ f.url }}" alt="{{ f.name }}">
        {% else %}
          <small>{{ f.name }}</small>
        {% endif %}
        <div class="file-actions">
          <a class="btn" href="{{ f.url }}" download="{{ f.name }}">Download</a>
        </div>
        <small>{{ f.name }} • {{ (f.size/1024)|round(1) }} KB</small>
      </div>
    {% endfor %}
  {% else %}
    <p class="muted">아직 생성된 파일이 없습니다.</p>
  {% endif %}
</aside>
</main>

<!-- ===== [NEW] 상관행렬 셀 색상 스크립트 ===== -->
<script>
  (function colorizeCorr(){
    const table = document.getElementById('corr-table');
    if (!table) return;
    const cells = table.querySelectorAll('.corr-cell');
    cells.forEach(td => {
      const raw = td.dataset.val;
      const v = parseFloat(raw);
      if (!isFinite(v)) return;
      const a = Math.min(0.85, Math.abs(v));     // 농도
      const hue = v >= 0 ? 210 : 20;             // +파랑, -주황
      td.style.backgroundColor = `hsla(${hue}, 80%, 55%, ${a})`;
    });
  })();
</script>
<!-- ===== [NEW] 끝 ===== -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const nodes = document.querySelectorAll(".bot .md-raw");
    console.log("렌더링 대상:", nodes.length);
    nodes.forEach(rawNode => {
      const rawText = rawNode.textContent || "";
      if (!rawText.trim()) return;
      const html = marked.parse(rawText);
      const safe = DOMPurify.sanitize(html, {USE_PROFILES:{html:true}});
      const rendered = rawNode.parentElement.querySelector(".md-rendered");
      if (rendered) rendered.innerHTML = safe;
      rawNode.remove();
    });

    // 렌더된 마크다운 안의 <table>을 가로 스크롤 랩퍼로 감싸기
    document.querySelectorAll(".bot .md-rendered").forEach(rendered => {
      rendered.querySelectorAll("table").forEach(tbl => {
        if (!tbl.parentElement.classList.contains("md-scroll-x")) {
          const wrap = document.createElement("div");
          wrap.className = "md-scroll-x";
          tbl.parentNode.insertBefore(wrap, tbl);
          wrap.appendChild(tbl);
        }
      });
    });

    // 자동 스크롤
    const chatList = document.getElementById("chatList");
    if (chatList) setTimeout(() => chatList.scrollTop = chatList.scrollHeight, 300);
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const chatList = document.querySelector(".chat-list");
    if (!chatList) return;

    // 마지막 말풍선 요소 찾기
    const lastBubble = chatList.querySelector(".bubble:last-child");
    if (lastBubble) {
      // 부드럽게 해당 말풍선의 시작 부분으로 스크롤 이동
      setTimeout(() => {
        lastBubble.scrollIntoView({ block: "start" });
      }, 100);
    }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const toggleBtn = document.getElementById("toggle-right-panel");
  const rightPanel = document.querySelector(".panel.right");
  const layout = document.querySelector(".layout");

  let isHidden = false;

  toggleBtn.addEventListener("click", () => {
    isHidden = !isHidden;

    if (isHidden) {
      rightPanel.style.display = "none";
      layout.style.gridTemplateColumns = "40% 60%"; // 오른쪽 패널 숨김 → 중앙 확장
      toggleBtn.textContent = "📁 파일 보기";
    } else {
      rightPanel.style.display = "block";
      layout.style.gridTemplateColumns = "35% 45% 20%"; // 원래 비율 복원
      toggleBtn.textContent = "📁 파일 숨기기";
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const chatForm   = document.getElementById("chatForm");              
  const chatInput  = chatForm?.querySelector('input[name="message"]');
  const chatSendBtn= chatForm?.querySelector('button[type="submit"]');
  const chatList   = document.getElementById("chatList");
  let pending = false;

  // 마크다운 렌더 + 표 가로 스크롤 래핑
  function renderMarkdownInBubbles(root) {
    const nodes = root.querySelectorAll(".bot .md-raw");
    nodes.forEach(rawNode => {
      const rawText = rawNode.textContent || "";
      if (!rawText.trim()) return;
      const html = marked.parse(rawText);
      const safe = DOMPurify.sanitize(html, {USE_PROFILES:{html:true}});
      const rendered = rawNode.parentElement.querySelector(".md-rendered");
      if (rendered) rendered.innerHTML = safe;
      rawNode.remove();
    });
    root.querySelectorAll(".bot .md-rendered").forEach(rendered => {
      rendered.querySelectorAll("table").forEach(tbl => {
        if (!tbl.parentElement.classList.contains("md-scroll-x")) {
          const wrap = document.createElement("div");
          wrap.className = "md-scroll-x";
          tbl.parentNode.insertBefore(wrap, tbl);
          wrap.appendChild(tbl);
        }
      });
    });
  }

  function addTypingBubble() {
    const chatList = document.getElementById("chatList");
    if (!chatList) return;

    // 이미 표시 중이면 새로 만들지 않음(중복 방지)
    const already = chatList.querySelector('.bubble.bot.typing[data-typing="true"]');
    if (already) return;

    const bubble = document.createElement("div");
    bubble.className = "bubble bot typing";         // ← .bot .typing 둘 다!
    bubble.dataset.typing = "true";
    bubble.setAttribute("aria-live", "polite");
    bubble.setAttribute("aria-label", "답변 작성 중");

    // 점(…) 애니메이션 3개
    bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';

    chatList.appendChild(bubble);
    chatList.scrollTop = chatList.scrollHeight;
  }

  function removeTypingBubble() {
    const chatList = document.getElementById("chatList");
    if (!chatList) return;

    const typing = chatList.querySelector('.bubble.bot.typing[data-typing="true"]');
    if (typing && typing.parentNode) typing.parentNode.removeChild(typing);
  }

  if (chatForm && chatInput && chatSendBtn && chatList) {
    chatForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      if (pending) return;
      pending = true;

      // ⭐ FormData를 먼저 만든다 (disabled 전에!)
      const fd = new FormData(chatForm);
      const userMsg = chatInput.value;

      // 입력/버튼 잠금
      const prevPlaceholder = chatInput.placeholder;
      const prevBtnText = chatSendBtn.textContent;
      chatInput.disabled = true;
      chatSendBtn.disabled = true;
      chatInput.placeholder = "응답 작성 중…";
      chatSendBtn.textContent = "응답 중…";

      // 내 메시지 즉시 표시(옵션)
      if (userMsg.trim()) {
        const me = document.createElement("div");
        me.className = "bubble me";
        me.textContent = userMsg;
        chatList.appendChild(me);
      }

      // 타자(…) 표시
      addTypingBubble();

      try {
        const res = await fetch(chatForm.action, { method: "POST", body: fd });
        const html = await res.text();

        // 응답에서 #chatList만 교체
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const newChatList = doc.querySelector("#chatList");

        removeTypingBubble();

        if (newChatList) {
          chatList.replaceChildren(...newChatList.childNodes);
          renderMarkdownInBubbles(chatList);
          chatList.scrollTop = chatList.scrollHeight;
        }

        // (선택) 오른쪽 패널 동기 갱신
        const newRight = doc.querySelector(".panel.right");
        const curRight = document.querySelector(".panel.right");
        if (newRight && curRight) curRight.innerHTML = newRight.innerHTML;

      } catch (err) {
        console.error(err);
        removeTypingBubble();
        const errBubble = document.createElement("div");
        errBubble.className = "bubble bot";
        errBubble.textContent = "⚠️ 전송 중 오류가 발생했어요. 다시 시도해주세요.";
        chatList.appendChild(errBubble);
      } finally {
        chatInput.value = "";
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.placeholder = prevPlaceholder;
        chatSendBtn.textContent = prevBtnText;
        chatInput.focus();
        pending = false;
      }
    });
  }

  // (선택) 워크플로우 버튼 잠금 표시
  const wfForm = document.querySelector('form[action="/run_workflow/"]');
  if (wfForm) {
    const wfBtn = wfForm.querySelector('button[type="submit"]');
    wfForm.addEventListener("submit", () => {
      if (!wfBtn) return;
      wfBtn.disabled = true;
      wfBtn.dataset.old = wfBtn.textContent;
      wfBtn.textContent = "실행 중…";
    });
  }
});
</script>

</body>
</html>
